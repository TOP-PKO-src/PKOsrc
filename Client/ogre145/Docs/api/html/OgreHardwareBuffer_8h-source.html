<html>
<head>
<title>OGRE: OgreHardwareBuffer.h Source File - OGRE Documentation</title> <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"> 
<link type="text/css" rel="stylesheet" href="doxygen.css">
<link type="text/css" rel="stylesheet" href="tabs.css">
</head>

<body>
<!-- Generated by Doxygen 1.4.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">OgreMain</a>&nbsp;/&nbsp;<a class="el" href="dir_000001.html">include</a></div>
<h1>OgreHardwareBuffer.h</h1><a href="OgreHardwareBuffer_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment">-----------------------------------------------------------------------------</span>
00003 <span class="comment">This source file is part of OGRE</span>
00004 <span class="comment">    (Object-oriented Graphics Rendering Engine)</span>
00005 <span class="comment">For the latest info, see http://www.ogre3d.org/</span>
00006 <span class="comment"></span>
00007 <span class="comment">Copyright (c) 2000-2006 Torus Knot Software Ltd</span>
00008 <span class="comment">Also see acknowledgements in Readme.html</span>
00009 <span class="comment"></span>
00010 <span class="comment">This program is free software; you can redistribute it and/or modify it under</span>
00011 <span class="comment">the terms of the GNU Lesser General Public License as published by the Free Software</span>
00012 <span class="comment">Foundation; either version 2 of the License, or (at your option) any later</span>
00013 <span class="comment">version.</span>
00014 <span class="comment"></span>
00015 <span class="comment">This program is distributed in the hope that it will be useful, but WITHOUT</span>
00016 <span class="comment">ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
00017 <span class="comment">FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more details.</span>
00018 <span class="comment"></span>
00019 <span class="comment">You should have received a copy of the GNU Lesser General Public License along with</span>
00020 <span class="comment">this program; if not, write to the Free Software Foundation, Inc., 59 Temple</span>
00021 <span class="comment">Place - Suite 330, Boston, MA 02111-1307, USA, or go to</span>
00022 <span class="comment">http://www.gnu.org/copyleft/lesser.txt.</span>
00023 <span class="comment"></span>
00024 <span class="comment">You may alternatively use this source under the terms of a specific version of</span>
00025 <span class="comment">the OGRE Unrestricted License provided you have obtained such a license from</span>
00026 <span class="comment">Torus Knot Software Ltd.</span>
00027 <span class="comment">-----------------------------------------------------------------------------</span>
00028 <span class="comment">*/</span>
00029 <span class="preprocessor">#ifndef __HardwareBuffer__</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#define __HardwareBuffer__</span>
00031 <span class="preprocessor"></span>
00032 <span class="comment">// Precompiler options</span>
00033 <span class="preprocessor">#include "<a class="code" href="OgrePrerequisites_8h.html">OgrePrerequisites.h</a>"</span>
00034 
00035 <span class="keyword">namespace </span>Ogre {
00036 
<a name="l00068"></a><a class="code" href="classOgre_1_1HardwareBuffer.html">00068</a>     <span class="keyword">class </span><a class="code" href="OgrePlatform_8h.html#a16">_OgreExport</a> HardwareBuffer 
00069     {
00070 
00071         <span class="keyword">public</span>:
<a name="l00073"></a><a class="code" href="classOgre_1_1HardwareBuffer.html#Ogre_1_1HardwareVertexBufferw11">00073</a>             <span class="keyword">enum</span> Usage 
00074             {
00078                 HBU_STATIC = 1,
00084                 HBU_DYNAMIC = 2,
00091                 HBU_WRITE_ONLY = 4,
00100                 HBU_DISCARDABLE = 8,
00102                 HBU_STATIC_WRITE_ONLY = 5, 
00108                 HBU_DYNAMIC_WRITE_ONLY = 6,
00110                 HBU_DYNAMIC_WRITE_ONLY_DISCARDABLE = 14
00111 
00112 
00113             };
<a name="l00115"></a><a class="code" href="classOgre_1_1HardwareBuffer.html#Ogre_1_1HardwareVertexBufferw12">00115</a>             <span class="keyword">enum</span> LockOptions
00116             {
00118                 HBL_NORMAL,
00123                 HBL_DISCARD,
00127                 HBL_READ_ONLY,
00131                 HBL_NO_OVERWRITE
00132                 
00133             };
00134         <span class="keyword">protected</span>:
<a name="l00135"></a><a class="code" href="classOgre_1_1HardwareBuffer.html#Ogre_1_1HardwareVertexBufferp2">00135</a>             size_t mSizeInBytes;
<a name="l00136"></a><a class="code" href="classOgre_1_1HardwareBuffer.html#Ogre_1_1HardwareVertexBufferp3">00136</a>             Usage mUsage;
<a name="l00137"></a><a class="code" href="classOgre_1_1HardwareBuffer.html#Ogre_1_1HardwareVertexBufferp4">00137</a>             <span class="keywordtype">bool</span> mIsLocked;
<a name="l00138"></a><a class="code" href="classOgre_1_1HardwareBuffer.html#Ogre_1_1HardwareVertexBufferp5">00138</a>             size_t mLockStart;
<a name="l00139"></a><a class="code" href="classOgre_1_1HardwareBuffer.html#Ogre_1_1HardwareVertexBufferp6">00139</a>             size_t mLockSize;
<a name="l00140"></a><a class="code" href="classOgre_1_1HardwareBuffer.html#Ogre_1_1HardwareVertexBufferp7">00140</a>             <span class="keywordtype">bool</span> mSystemMemory;
<a name="l00141"></a><a class="code" href="classOgre_1_1HardwareBuffer.html#Ogre_1_1HardwareVertexBufferp8">00141</a>             <span class="keywordtype">bool</span> mUseShadowBuffer;
<a name="l00142"></a><a class="code" href="classOgre_1_1HardwareBuffer.html#Ogre_1_1HardwareVertexBufferp9">00142</a>             HardwareBuffer* mpShadowBuffer;
<a name="l00143"></a><a class="code" href="classOgre_1_1HardwareBuffer.html#Ogre_1_1HardwareVertexBufferp10">00143</a>             <span class="keywordtype">bool</span> mShadowUpdated;
<a name="l00144"></a><a class="code" href="classOgre_1_1HardwareBuffer.html#Ogre_1_1HardwareVertexBufferp11">00144</a>             <span class="keywordtype">bool</span> mSuppressHardwareUpdate;
00145             
00147             <span class="keyword">virtual</span> <span class="keywordtype">void</span>* lockImpl(size_t offset, size_t length, LockOptions options) = 0;
00149             <span class="keyword">virtual</span> <span class="keywordtype">void</span> unlockImpl(<span class="keywordtype">void</span>) = 0;
00150 
00151     <span class="keyword">public</span>:
<a name="l00153"></a><a class="code" href="classOgre_1_1HardwareBuffer.html#Ogre_1_1HardwareBuffera0">00153</a>             HardwareBuffer(Usage usage, <span class="keywordtype">bool</span> systemMemory, <span class="keywordtype">bool</span> useShadowBuffer) 
00154                 : mUsage(usage), mIsLocked(false), mSystemMemory(systemMemory), 
00155                 mUseShadowBuffer(useShadowBuffer), mpShadowBuffer(NULL), mShadowUpdated(false), 
00156                 mSuppressHardwareUpdate(false) 
00157             {
00158                 <span class="comment">// If use shadow buffer, upgrade to WRITE_ONLY on hardware side</span>
00159                 <span class="keywordflow">if</span> (useShadowBuffer &amp;&amp; usage == HBU_DYNAMIC)
00160                 {
00161                     mUsage = HBU_DYNAMIC_WRITE_ONLY;
00162                 }
00163                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (useShadowBuffer &amp;&amp; usage == HBU_STATIC)
00164                 {
00165                     mUsage = HBU_STATIC_WRITE_ONLY;
00166                 }
00167             }
<a name="l00168"></a><a class="code" href="classOgre_1_1HardwareBuffer.html#Ogre_1_1HardwareBuffera1">00168</a>             <span class="keyword">virtual</span> ~HardwareBuffer() {}
<a name="l00175"></a><a class="code" href="classOgre_1_1HardwareBuffer.html#Ogre_1_1HardwareVertexBuffera4">00175</a>             <span class="keyword">virtual</span> <span class="keywordtype">void</span>* lock(size_t offset, size_t length, LockOptions options)
00176             {
00177                 assert(!isLocked() &amp;&amp; <span class="stringliteral">"Cannot lock this buffer, it is already locked!"</span>);
00178                 <span class="keywordtype">void</span>* ret;
00179                 <span class="keywordflow">if</span> (mUseShadowBuffer)
00180                 {
00181                     <span class="keywordflow">if</span> (options != HBL_READ_ONLY)
00182                     {
00183                         <span class="comment">// we have to assume a read / write lock so we use the shadow buffer</span>
00184                         <span class="comment">// and tag for sync on unlock()</span>
00185                         mShadowUpdated = <span class="keyword">true</span>;
00186                     }
00187 
00188                     ret = mpShadowBuffer-&gt;lock(offset, length, options);
00189                 }
00190                 <span class="keywordflow">else</span>
00191                 {
00192                     <span class="comment">// Lock the real buffer if there is no shadow buffer </span>
00193                     ret = lockImpl(offset, length, options);
00194                     mIsLocked = <span class="keyword">true</span>;
00195                 }
00196                 mLockStart = offset;
00197                 mLockSize = length;
00198                 <span class="keywordflow">return</span> ret;
00199             }
00200 
<a name="l00205"></a><a class="code" href="classOgre_1_1HardwareBuffer.html#Ogre_1_1HardwareVertexBuffera5">00205</a>             <span class="keywordtype">void</span>* lock(LockOptions options)
00206             {
00207                 <span class="keywordflow">return</span> this-&gt;lock(0, mSizeInBytes, options);
00208             }
<a name="l00221"></a><a class="code" href="classOgre_1_1HardwareBuffer.html#Ogre_1_1HardwareVertexBuffera6">00221</a>             <span class="keyword">virtual</span> <span class="keywordtype">void</span> unlock(<span class="keywordtype">void</span>)
00222             {
00223                 assert(isLocked() &amp;&amp; <span class="stringliteral">"Cannot unlock this buffer, it is not locked!"</span>);
00224 
00225                 <span class="comment">// If we used the shadow buffer this time...</span>
00226                 <span class="keywordflow">if</span> (mUseShadowBuffer &amp;&amp; mpShadowBuffer-&gt;isLocked())
00227                 {
00228                     mpShadowBuffer-&gt;unlock();
00229                     <span class="comment">// Potentially update the 'real' buffer from the shadow buffer</span>
00230                     _updateFromShadow();
00231                 }
00232                 <span class="keywordflow">else</span>
00233                 {
00234                     <span class="comment">// Otherwise, unlock the real one</span>
00235                     unlockImpl();
00236                     mIsLocked = <span class="keyword">false</span>;
00237                 }
00238 
00239             }
00240 
00247             <span class="keyword">virtual</span> <span class="keywordtype">void</span> readData(size_t offset, size_t length, <span class="keywordtype">void</span>* pDest) = 0;
00256             <span class="keyword">virtual</span> <span class="keywordtype">void</span> writeData(size_t offset, size_t length, <span class="keyword">const</span> <span class="keywordtype">void</span>* pSource,
00257                     <span class="keywordtype">bool</span> discardWholeBuffer = <span class="keyword">false</span>) = 0;
00258 
<a name="l00269"></a><a class="code" href="classOgre_1_1HardwareBuffer.html#Ogre_1_1HardwareVertexBuffera9">00269</a>             <span class="keyword">virtual</span> <span class="keywordtype">void</span> copyData(HardwareBuffer&amp; srcBuffer, size_t srcOffset, 
00270                 size_t dstOffset, size_t length, <span class="keywordtype">bool</span> discardWholeBuffer = <span class="keyword">false</span>)
00271             {
00272                 <span class="keyword">const</span> <span class="keywordtype">void</span> *srcData = srcBuffer.lock(
00273                     srcOffset, length, HBL_READ_ONLY);
00274                 this-&gt;writeData(dstOffset, length, srcData, discardWholeBuffer);
00275                 srcBuffer.unlock();
00276             }
00277 
<a name="l00279"></a><a class="code" href="classOgre_1_1HardwareBuffer.html#Ogre_1_1HardwareVertexBuffera10">00279</a>             <span class="keyword">virtual</span> <span class="keywordtype">void</span> _updateFromShadow(<span class="keywordtype">void</span>)
00280             {
00281                 <span class="keywordflow">if</span> (mUseShadowBuffer &amp;&amp; mShadowUpdated &amp;&amp; !mSuppressHardwareUpdate)
00282                 {
00283                     <span class="comment">// Do this manually to avoid locking problems</span>
00284                     <span class="keyword">const</span> <span class="keywordtype">void</span> *srcData = mpShadowBuffer-&gt;lockImpl(
00285                         mLockStart, mLockSize, HBL_READ_ONLY);
00286                     <span class="comment">// Lock with discard if the whole buffer was locked, otherwise normal</span>
00287                     LockOptions lockOpt;
00288                     <span class="keywordflow">if</span> (mLockStart == 0 &amp;&amp; mLockSize == mSizeInBytes)
00289                         lockOpt = HBL_DISCARD;
00290                     <span class="keywordflow">else</span>
00291                         lockOpt = HBL_NORMAL;
00292                     
00293                     <span class="keywordtype">void</span> *destData = this-&gt;lockImpl(
00294                         mLockStart, mLockSize, lockOpt);
00295                     <span class="comment">// Copy shadow to real</span>
00296                     memcpy(destData, srcData, mLockSize);
00297                     this-&gt;unlockImpl();
00298                     mpShadowBuffer-&gt;unlockImpl();
00299                     mShadowUpdated = <span class="keyword">false</span>;
00300                 }
00301             }
00302 
<a name="l00304"></a><a class="code" href="classOgre_1_1HardwareBuffer.html#Ogre_1_1HardwareVertexBuffera11">00304</a>             size_t getSizeInBytes(<span class="keywordtype">void</span>)<span class="keyword"> const </span>{ <span class="keywordflow">return</span> mSizeInBytes; }
<a name="l00306"></a><a class="code" href="classOgre_1_1HardwareBuffer.html#Ogre_1_1HardwareVertexBuffera12">00306</a>             Usage getUsage(<span class="keywordtype">void</span>)<span class="keyword"> const </span>{ <span class="keywordflow">return</span> mUsage; }
<a name="l00308"></a><a class="code" href="classOgre_1_1HardwareBuffer.html#Ogre_1_1HardwareVertexBuffera13">00308</a>             <span class="keywordtype">bool</span> isSystemMemory(<span class="keywordtype">void</span>)<span class="keyword"> const </span>{ <span class="keywordflow">return</span> mSystemMemory; }
<a name="l00310"></a><a class="code" href="classOgre_1_1HardwareBuffer.html#Ogre_1_1HardwareVertexBuffera14">00310</a>             <span class="keywordtype">bool</span> hasShadowBuffer(<span class="keywordtype">void</span>)<span class="keyword"> const </span>{ <span class="keywordflow">return</span> mUseShadowBuffer; }
<a name="l00312"></a><a class="code" href="classOgre_1_1HardwareBuffer.html#Ogre_1_1HardwareVertexBuffera15">00312</a>             <span class="keywordtype">bool</span> isLocked(<span class="keywordtype">void</span>)<span class="keyword"> const </span>{ 
00313                 <span class="keywordflow">return</span> mIsLocked || (mUseShadowBuffer &amp;&amp; mpShadowBuffer-&gt;isLocked()); 
00314             }
<a name="l00316"></a><a class="code" href="classOgre_1_1HardwareBuffer.html#Ogre_1_1HardwareVertexBuffera16">00316</a>             <span class="keywordtype">void</span> suppressHardwareUpdate(<span class="keywordtype">bool</span> suppress) {
00317                 mSuppressHardwareUpdate = suppress;
00318                 <span class="keywordflow">if</span> (!suppress)
00319                     _updateFromShadow();
00320             }
00321 
00322 
00323 
00324 
00325             
00326     };
00327 }
00328 <span class="preprocessor">#endif</span>
00329 <span class="preprocessor"></span>
00330 
</pre></div><hr>
<p>
Copyright &copy; 2000-2005 by The OGRE Team<br />
<!--Creative Commons License--><a rel="license" href="http://creativecommons.org/licenses/by-sa/2.5/"><img alt="Creative Commons License" border="0" src="http://creativecommons.org/images/public/somerights20.png"/></a><br/>
This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/2.5/">Creative Commons Attribution-ShareAlike 2.5 License</a>.<br/>
		<!--/Creative Commons License--><!-- <rdf:RDF xmlns="http://web.resource.org/cc/" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
		<Work rdf:about="">
			<license rdf:resource="http://creativecommons.org/licenses/by-sa/2.5/" />
	<dc:type rdf:resource="http://purl.org/dc/dcmitype/Text" />
		</Work>
		<License rdf:about="http://creativecommons.org/licenses/by-sa/2.5/"><permits rdf:resource="http://web.resource.org/cc/Reproduction"/><permits rdf:resource="http://web.resource.org/cc/Distribution"/><requires rdf:resource="http://web.resource.org/cc/Notice"/><requires rdf:resource="http://web.resource.org/cc/Attribution"/><permits rdf:resource="http://web.resource.org/cc/DerivativeWorks"/><requires rdf:resource="http://web.resource.org/cc/ShareAlike"/></License></rdf:RDF> -->

Last modified Sun Sep 30 10:50:56 2007
</p>
</body>
</html>
